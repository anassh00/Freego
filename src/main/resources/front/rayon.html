<!DOCTYPE html>
<html>
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <!-- Style -->
    <link rel="stylesheet" href="css/style.css">

    <!-- Google Icon -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <title>Rayon - Freego</title>

    <style>
      .imgProduit {
        width: 90px;
        height: 90px;
        border-radius: 10px;
        background-color: #E94E1B;
      }
      .rayonProduct a {
        text-decoration: none;
      }
      .rayonProduct button {
        color: #E94E1B;
        background-color: white;
        border: 1px solid #E94E1B;
        border-radius: 20px;
        width: fit-content;
      }
      .donneur {
        display: flex;
        align-items: center;
        justify-content: right;
      }
      .donneur span {
        color: #345DA8;
        font-size: 14px;
        text-align: right;
        width: 100%;
      }
      .rayonProduct > .row > .col > .row {
        height: 33%;
      }
      .distance {
        display: flex;
        align-items: center;
      }
      .distance i {
        color: #345DA8;
      }
      .distance span {
        color: #E94E1B;
        padding-right: 0;
      }
      .productTitle {
        margin-bottom: 0;
      }
    </style>
  </head>
  <body>
    <div class="allContent">
      <div id="head-section-bis">
        <div class="row m-1">
          <div class="col-auto">
            <a href="rayons.html"><i class="material-icons orangeIcon">keyboard_backspace</i></a>
          </div>
          <div class="col" style="display: flex; justify-content: right;">
            <img src="images/logo_orange.png"/>
          </div>
        </div>
      </div>
      <div style="height: 60px"></div>
      <h3 id="rayonTitle" class="mt-3" style="text-align: center"></h3>
      <div class="section mx-3">
        <div class="form-group">
          <input class="my-3" type="text form-control" onkeyup="searchRayon()" id="searchBar" placeholder="Rechercher un produit..."/>
          <i class="material-icons" id="searchBarLogo">search</i>
        </div>
        <div class="rayonProduct"></div>
      </div>

      <div style="height:50px"></div>
      <div id="footNavBar"></div>
    </div>

    <!-- Ecran de chargement -->
    <div id="ecranChargement"></div>

    <!-- Bootstrap Script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <!-- Script -->
    <script src="js/script.js"></script>
    <script src="js/requetes.js"></script>
    <!-- jQuery -->
    <script src="js/jQuery.js"></script>
    <script>
      $(function(){
        $("#ecranChargement").load("ecranChargement.html");
        $("#ecranChargement").fadeIn();
        $("#footNavBar").load("footNavBar.html");
      });

      onload = function() {
        if(sessionStorage.getItem('userID') == null) {
          location.href = "connexion.html";
        } else {
          const url = new URL(location.href);
          const search_params = new URLSearchParams(url.search);
          if(search_params.has('catID')) {
            const catID = search_params.get('catID');
            $.ajax(getCategoryById(catID)).done(function (response) {
              document.querySelector("#rayonTitle").innerHTML = '<b>' + response.name + '</b>';
            });
            $.ajax(getProductsByCategory(catID)).done(function (response) {
              const products = [];
              for(let i = 0; i < response.length; i++) {
                if(response[i].user.id != sessionStorage.getItem('userID')) {
                  products.push(response[i]);
                }
              }
              const rayon = document.querySelector(".rayonProduct");
              for(let i = 0; i < products.length; i++) {
                rayon.innerHTML +=
                  '<div class="row mb-3">' +
                    '<div class="col-auto">' +
                      '<a href="product.html?productID=' + products[i].id_product + '">' +
                        '<div class="imgProduit"></div>' +
                      '</a>' +
                    '</div>' +
                    '<div class="col">' +
                      '<div class="row">' +
                        '<h6 class="productTitle">' + products[i].name + '</h6>' +
                      '</div>' +
                      '<div class="row">' +
                        '<div class="col-auto distance">' +
                          '<i class="material-icons">location_on</i>' +
                          '<span>.. km</span>'+
                        '</div>' +
                        '<div class="col donneur">' +
                          '<span>par ' + products[i].user.first_name + ' ' + products[i].user.last_name + '</span>' +
                        '</div>' +
                      '</div>' +
                      '<div class="row">' +
                        '<div class="col">' +
                          '<button class="px-1" onclick="location.href = \'message.html?userID=' + products[i].user.id + '\';">Message</button>' +
                        '</div>' +
                        '<div class="col-auto">' +
                          '<button class="px-1" onclick="location.href = \'profil.html?userID=' + products[i].user.id + '\';">Voir le freego</button>' +
                        '</div>' +
                        '</div>' +
                      '</div>' +
                    '</div>' +
                  '</div>';
              }
              fFinChargement();
            });
          }
        }
      }
    </script>
  </body>
</html>