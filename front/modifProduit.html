<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Modification - Freego</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="bootstrap-5.2.3-dist/css/bootstrap.css">

    <!-- Style -->
    <link rel="stylesheet" href="css/style.css">

    <!-- Google Icon -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <style>
        #ajoutPhoto {
            background-color: #E94E1B;
            height: fit-content;
        }
        span {
            color: white;
            text-align: center;
        }
        .productImage {
            border-radius: 10px;
            height: 90px;
            width: 90px;
            object-fit: cover;
        }
        .productImageCol {
            display: flex;
            justify-content: center;
        }
        #categEtat {
            background-color: #E94E1B;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        #titreDesc {
            background-color: #E94E1B;
            margin-top:1rem;
        }
        #btnAjout {
            display: flex;
            justify-content: center;
        }
        #categSelect {
            position: absolute;
            background-color: #FE835A;
            top: 132px;
            right: 5%;
            width: 90%;
            z-index: 1;
        }
        #categSelect a {
            text-decoration: none;
            color: white;
        }
        #categSelect a .row {
            display: flex;
            justify-content: center;
            border-bottom: 1px solid white;
            margin: 0;
        }
        #etatSelect {
            position: absolute;
            background-color: #FE835A;
            top: 178px;
            right: 5%;
            width: 90%;
            z-index: 1;
        }
        #etatSelect a {
            text-decoration: none;
            color: white;
        }
        #etatSelect a .row {
            display: flex;
            justify-content: center;
            border-bottom: 1px solid white;
            margin: 0;
        }

        #modalContainer {
            background-color:rgba(0, 0, 0, 0.3);
            position:absolute;
            width:100%;
            height:100%;
            top:0px;
            left:0px;
            z-index:10000;
        }
        #modal {
            position: relative;
            width: 90%;
            height: fit-content;
            background-color: #345DA8;
            left: 5%;
            top: 20%;
            border-radius: 20px;
        }
        #titreAnn, #descAnn {
            background-color: transparent;
            border: none;
            color: white;
        }
        #titreAnn:focus, #descAnn:focus {
            outline: none !important;
        }
    </style>
    <link href="css/input_form.css" type="text/css" rel="stylesheet"/>
</head>
<body>
    <div class="allContent">
        <div id="head-section-bis">
            <div class="row m-1">
                <div class="col-auto">
                    <a href="home.html"><i class="material-icons orangeIcon">keyboard_backspace</i></a>
                </div>
                <div class="col" style="display: flex; justify-content: right;">
                    <img src="images/logo_orange.png"/>
                </div>
            </div>
        </div>
        <div style="height: 70px"></div>
        <div id="categEtat" class="p-3">
            <a href="javascript:void(0)" onclick="fDisplayUnderMenu('#categSelect')" style="text-decoration: none; color: white;">
                <div class="row">
                    <div id="categorie" class="col">
                        Catégorie
                    </div>
                    <div class="col-auto">
                        <i class="material-icons">chevron_right</i>
                    </div>
                </div>
            </a>
            <hr style="color: white; opacity: 1; margin-top: 0">
            <div id="categSelect" style="display: none"></div>
            <div id="modalContainer" style="display: none">
                <div id="modal" class="p-3">
                    <div style="display: flex; justify-content: center;"><i class="material-icons" style="font-size: 60px; color: white">report</i></div>
                    <div class="mx-4">
                        <p style="text-align: center; color: white;">Nous n’acceptons pas les produits laitiers dont la date est dépassée de plus de 2 semaines.
                            Afin que notre équipe puisse vérifier, veuillez mettre une photo de la date limite de consommation.</p>
                    </div>
                    <div class="my-3" style="display: flex; justify-content: center">
                        <button class="btn_submit" onclick="document.querySelector('#modalContainer').style.display = 'none';">J'ai compris</button>
                    </div>
                </div>
            </div>
            <a href="javascript:void(0)" onclick="fDisplayUnderMenu('#etatSelect')" style="text-decoration: none; color: white;">
                <div class="row">
                    <div id="etat" class="col">
                        Etat
                    </div>
                    <div class="col-auto">
                        <i class="material-icons">chevron_right</i>
                    </div>
                </div>
            </a>
            <hr style="color: white; opacity: 1; margin-top: 0">
            <div id="etatSelect" style="display: none">
                <a href="javascript:void(0)" onclick="fChoixEtat(this)">
                    <div class="row p-3">
                        <span>Frais</span>
                    </div>
                </a>
                <a href="javascript:void(0)" onclick="fChoixEtat(this)">
                    <div class="row p-3">
                        <span>A consommer immédiatement</span>
                    </div>
                </a>
                <a href="javascript:void(0)" onclick="fChoixEtat(this)">
                    <div class="row p-3">
                        <span>A consommer rapidement</span>
                    </div>
                </a>
                <a hhref="javascript:void(0)" onclick="fChoixEtat(this)">
                    <div class="row p-3">
                        <span>A consommer dans la semaine</span>
                    </div>
                </a>
                <a href="javascript:void(0)" onclick="fChoixEtat(this)">
                    <div class="row p-3">
                        <span>A consommer dans le mois ou plus</span>
                    </div>
                </a>
            </div>
        </div>
        <div class="py-3" id="ajoutPhoto">
            <div class="row">
                <span>Je donne un produit</span>
            </div>
            <div class="row">
                <span style="font-size: 12px;">(3 photos maximum)</span>
            </div>
            <div class="row mb-3" style="display: flex; justify-content: center">
                <span style="font-size: 10px;">Cliquez ci-dessous pour ajouter ou modifier une image.</span>
            </div>
            <div class="row">
                <div class="col productImageCol">
                    <a href="javascript:void(0)" onclick="fAddImage1()">
                        <img id="imageProd1" class="productImage" src="images/no_image.jpg"/>
                    </a>
                    <input id="fileUploader1" type="file" accept="image/*" hidden/>
                </div>
                <div class="col productImageCol">
                    <a href="javascript:void(0)" onclick="fAddImage2()">
                        <img id="imageProd2" class="productImage" src="images/no_image.jpg"/>
                    </a>
                    <input id="fileUploader2" type="file" accept="image/*" hidden/>
                </div>
                <div class="col productImageCol">
                    <a href="javascript:void(0)" onclick="fAddImage3()">
                        <img id="imageProd3" class="productImage" src="images/no_image.jpg"/>
                    </a>
                    <input id="fileUploader3" type="file" accept="image/*" hidden/>
                </div>
            </div>
        </div>
        <div id="titreDesc" class="py-3">
            <div class="row mx-3">
                <label class="px-0" for="titreAnn" style="color: white;">Titre de l'annonce</label>
                <br>
                <input class="px-0" type="text" id="titreAnn" placeholder="Ex : carottes de mon jardin"/>
            </div>
            <hr class="mx-3" style="color: white; opacity: 1;">
            <div class="row mx-3">
                <label class="px-0" for="descAnn" style="color: white;">Description du produit</label>
                <br>
                <textarea class="px-0" type="text" id="descAnn" placeholder="Ex : cultivées sans pesticides..."></textarea>
            </div>
        </div>
        <div id="btnAjout" class="my-3">
            <button class="btn btnModifProfil" onclick="fUpdateProduct()" style="justify-content: center">Sauvegarder</button>
        </div>
    </div>

    <!-- Ecran de chargement -->
    <div id="ecranChargement"></div>

    <!-- Bootstrap Script -->
    <script src="bootstrap-5.2.3-dist/js/bootstrap.js"></script>
    <!-- Script -->
    <script src="js/script.js"></script>
    <script src="js/requetes.js"></script>
    <!-- jQuery -->
    <script src="js/jQuery.js"></script>

    <script>
        $(function(){
            $("#ecranChargement").load("ecranChargement.html");
            $("#ecranChargement").fadeIn();
        });
        let productID;
        onload = function() {
            if(sessionStorage.getItem('userID') == null) {
                location.href = "connexion.html";
            } else {
                $.ajax(getAllCategory()).done(function (response) {
                    const categSelect = document.querySelector("#categSelect");
                    for(let i = 0; i < response.length; i++) {
                        categSelect.innerHTML +=
                            '<a id="categNum' + response[i].id + '" href="javascript:void(0)" onClick="fChoixCateg(this)">' +
                                '<div class="row p-3">' +
                                    '<span>' + response[i].name + '</span>' +
                                '</div>' +
                            '</a>';
                    }
                    const url = new URL(location.href);
                    const search_params = new URLSearchParams(url.search);
                    if(search_params.has('productID')) {
                        productID = search_params.get('productID');
                        $.ajax(getProductById(productID)).done(function (response) {
                            document.querySelector("#categorie").innerHTML += ": <span>" + response.category.name + "</span>";
                            document.querySelector("#etat").innerHTML += ": <span>" + response.etat + "</span>";
                            document.querySelector("#titreAnn").value = response.name;
                            document.querySelector("#descAnn").value = response.description;
                            $.ajax(getProductImages(productID)).done(function (images) {
                                document.querySelector("#imageProd1").src = "data:image/png;base64," + images[0].image;
                                document.querySelector("#imageProd2").src = "data:image/png;base64," + images[1].image;
                                document.querySelector("#imageProd3").src = "data:image/png;base64," + images[2].image;
                            });
                            fFinChargement();
                        });
                    }

                });
            }
        }
        let image1;
        let image2;
        let image3;

        function fUpdateProduct() {
            const categorie = document.querySelector("#categorie").querySelector("span");
            const etat = document.querySelector("#etat").querySelector("span");
            const titre = document.querySelector("#titreAnn").value;
            const description = document.querySelector("#descAnn").value;
            if(categorie != null && etat != null && titre != "" && description != "") {
                $.ajax(updateProduct(productID, sessionStorage.getItem('currentRayon'), titre, description, etat.innerHTML, image1, image2, image3)).done(function (response) {
                    location.href = "product.html?productID=" + productID;
                });
            }
        }

        function fAddImage1() {
            document.querySelector("#fileUploader1").click();
        }
        document.querySelector("#fileUploader1").addEventListener("change", handleImage1, false);
        function handleImage1() {
            const files = this.files;
            const fr = new FileReader();
            fr.readAsDataURL(files[0]);
            fr.onload = function() {
                document.querySelector("#imageProd1").src = this.result;
                const formData = new FormData();
                formData.append("image", files[0]);
                image1 = 'product_' + new Date().getTime() + '_' + sessionStorage.getItem('userID');
                formData.append("name", image1);
                $.ajax(saveImage(formData)).done();
            }
        }

        function fAddImage2() {
            document.querySelector("#fileUploader2").click();
        }
        document.querySelector("#fileUploader2").addEventListener("change", handleImage2, false);
        function handleImage2() {
            const files = this.files;
            const fr = new FileReader();
            fr.readAsDataURL(files[0]);
            fr.onload = function() {
                document.querySelector("#imageProd2").src = this.result;
                const formData = new FormData();
                formData.append("image", files[0]);
                image2 = 'product_' + new Date().getTime() + '_' + sessionStorage.getItem('userID');
                formData.append("name", image2);
                $.ajax(saveImage(formData)).done();
            }
        }

        function fAddImage3() {
            document.querySelector("#fileUploader3").click();
        }
        document.querySelector("#fileUploader3").addEventListener("change", handleImage3, false);
        function handleImage3() {
            const files = this.files;
            const fr = new FileReader();
            fr.readAsDataURL(files[0]);
            fr.onload = function() {
                document.querySelector("#imageProd3").src = this.result;
                const formData = new FormData();
                formData.append("image", files[0]);
                image3 = 'product_' + new Date().getTime() + '_' + sessionStorage.getItem('userID');
                formData.append("name", image3);
                $.ajax(saveImage(formData)).done();
            }
        }
    </script>
</body>
</html>